#!/bin/sh
#
# CDDL HEADER START
#
# The contents of this file are subject to the terms of the
# Common Development and Distribution License (the "License").
# You may not use this file except in compliance with the License.
#
# You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
# or http://www.opensolaris.org/os/licensing.
# See the License for the specific language governing permissions
# and limitations under the License.
#
# When distributing Covered Code, include this CDDL HEADER in each
# file and include the License file at usr/src/OPENSOLARIS.LICENSE.
# If applicable, add the following below this CDDL HEADER, with the
# fields enclosed by brackets "[]" replaced with your own identifying
# information: Portions Copyright [yyyy] [name of copyright owner]
#
# CDDL HEADER END
#

#
# Copyright (c) 2008, 2011, Oracle and/or its affiliates. All rights reserved.
#

#
# Environment
#

PATH="/usr/bin"
export PATH

basename=`basename $0`
usage="\
Usage: $basename -n <name> -p <package> -s <stability> <file>...
       $basename --help"

help="$usage

Amends the given man pages to add a Solaris stability
classification and a note about source availability.

-n, -p, and -s affect man pages specified thereafter and may be
specified multiple times.

Arguments:

<file>
    The man page file to amend (in place).

-n <name>
    Specify the name of the project (required).

-p <package>
    Specify the name of the package (required).

-s <stability>
    A solaris stability level (required).

--help
    Display this message."

#
# Functions
#

# Usage: die [<message>] [<exitcode>]
die() {
    test -n "$1" && echo "$basename: $1"
    test -n "$2" && test "$2" -gt 0 && exit "$2"
    exit 0
}

# Adds the given nroff preprocessing flags to the flags on stdin, avoiding
# duplicates; outputs to stdout
addflags() {
    read flags

    for f in "$@"
    do
        case "$flags" in
            *${f}*) ;;
            *) flags="${flags}$f" ;;
        esac
    done

    echo "$flags"
}

# Amend the given man page file
process() {
    file="$1"
    flagre="^'"'\\" '

    # Add tbl (t) nroff preprocessing flag to existing flags, if any
    flags=`head -1 "$file" | grep "$flagre" | cut -f2 -d' ' | addflags t`

    # Remove existing flags from input
    grep -v "$flagre" "$file" | (

    # Replace flags and add comment header
    cat <<EOF
'\" $flags
.\"
.\" Modified to add a Solaris stability classification
.\" and a note about source availability.
.\"
EOF

cat

cat <<EOF
.\" Begin Oracle update
.SH ATTRIBUTES
See
.BR attributes (5)
for descriptions of the following attributes:
.sp
.TS
box;
cbp-1 | cbp-1
l | l .
ATTRIBUTE TYPE	ATTRIBUTE VALUE
=
Availability	$pkg
=
Interface Stability	$stability
.TE
.PP
.SH NOTES
Source for $project is available on http://opensolaris.org.
.\" End Oracle update
EOF
) > "$file"-

    # preserve permissions
    /usr/gnu/bin/chmod --reference="$file" "$file"-

    mv -f "$file"- "$file" || die "could not amend $opt" 1
}

#
# Main
#

project=
pkg=
stability=

test $# -gt 0 || set -- --help

while [ $# -gt 0 ]
do
    opt="$1"
    shift

    case "$opt" in
        --help)
            echo "$help"
            exit
        ;;

        -[nps])
            test $# -gt 0 || die "\"$opt\" requires an argument\n\n$usage"
            optarg="$1"
            shift

            case "$opt" in
                -n) project="$optarg" ;;
                -p) pkg="$optarg" ;;
                -s) stability="$optarg" ;;
            esac
        ;;

        *)
            test -f "$opt" || die "no such file: $opt"
            test -z "$project" && die "-n not specified\n\n$usage"
            test -z "$pkg" && die "-p not specified\n\n$usage"
            test -z "$stability" && die "-s not specified\n\n$usage"

            process "$opt"
        ;;
    esac
done
